<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Agendamentos - TimeWise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#121212',
                        'dark-surface': '#1E1E1E',
                        'orange-custom': '#f0971c'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-dark-bg text-gray-300">
    <!-- Navigation Bar with User Dropdown -->
    <nav class="bg-dark-surface p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-orange-custom text-2xl font-bold flex items-center">
                <i class="fas fa-clock mr-2"></i>TimeWise
            </h1>

            <!-- User Profile Dropdown -->
            <div id="userProfile" class="text-gray-300 hidden relative">
                <button id="menuButton" class="bg-orange-custom hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition duration-300 hover:shadow-lg flex items-center">
                    <span id="userName" class="mr-2"></span>
                    <i class="fas fa-chevron-down"></i>
                </button>

                <!-- Dropdown Menu -->
                <div id="dropdownMenu" class="absolute right-0 mt-2 w-48 bg-dark-surface rounded-md shadow-xl z-20 hidden">
                    <a href="estabelecimento.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-orange-custom hover:text-white">
                        <i class="fas fa-calendar-plus mr-2"></i>Agendar
                    </a>
                    <a href="Agendamentos.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-orange-custom hover:text-white">
                        <i class="fas fa-calendar-check mr-2"></i>Agendamentos
                    </a>
                    <a href="Perfil.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-orange-custom hover:text-white">
                        <i class="fas fa-user mr-2"></i>Perfil
                    </a>
                    <a href="../index.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-orange-custom hover:text-white">
                        <i class="fas fa-home mr-2"></i>Início
                    </a>
                    <button id="logoutButton" class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-orange-custom hover:text-white">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Content Section -->
    <div class="container mx-auto px-4 py-8">
        <h2 class="text-3xl font-bold mb-6 text-center text-orange-custom slide-in">
            <i class="fas fa-calendar-alt mr-2"></i>Meus Agendamentos
        </h2>
        <div id="agendamentosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Modal de Pagamento -->
    <div id="paymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-dark-surface rounded-lg overflow-hidden shadow-2xl w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto">
            <!-- Modal content goes here -->
        </div>
    </div>

    <!-- Modal de Avaliação -->
    <div id="ratingModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-dark-surface rounded-lg overflow-hidden shadow-2xl w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto">
            <!-- Rating modal content goes here -->
        </div>
    </div>

    <!-- Footer Section with Appointment History -->
    <div id="agendamentosRealizadosSection" class="mt-8">
        <h2 class="text-2xl font-bold mb-4 text-center text-orange-custom">Agendamentos Realizados</h2>
        <div id="agendamentosRealizados" class="flex flex-wrap justify-center"></div>
    </div>

    <!-- Firebase JS and Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/util.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/appointments.js"></script>
    <script src="../js/payment.js"></script>
    <script src="../js/rating.js"></script>
    <script src="../js/coment.js"></script>

    <script>
        // Inicialização e carregamento principal
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM carregado, verificando autenticação...");

            // Firebase auth state listener
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log("Usuário autenticado:", user.uid);
                    showUserProfile(user);
                    carregarAgendamentos(user);
                } else {
                    console.log("Usuário não autenticado, redirecionando...");
                    window.location.href = 'LoginTimeWise.html';
                }
            });

            // Dropdown toggle
            const menuButton = document.getElementById('menuButton');
            const dropdownMenu = document.getElementById('dropdownMenu');
            menuButton.addEventListener('click', () => {
                dropdownMenu.classList.toggle('hidden');
            });

            // Logout logic
            document.getElementById('logoutButton').addEventListener('click', () => {
                auth.signOut().then(() => {
                    console.log("Usuário deslogado.");
                    window.location.href = 'LoginTimeWise.html';
                }).catch((error) => {
                    console.error("Erro ao deslogar:", error);
                });
            });
        });

        /**
         * Exibe o perfil do usuário autenticado.
         */
        function showUserProfile(user) {
            const userName = document.getElementById('userName');
            const userProfile = document.getElementById('userProfile');

            // Display user profile
            userProfile.classList.remove('hidden');
            userName.textContent = user.displayName || 'Usuário';
        }

        /**
         * Carrega os agendamentos do usuário do Firestore.
         */
        function carregarAgendamentos(user) {
            const agendamentosList = document.getElementById('agendamentosList');
            agendamentosList.innerHTML = '<p>Carregando agendamentos...</p>';

            const appointmentsRef = db.collection('appointments').where('userId', '==', user.uid);
            appointmentsRef.get().then((querySnapshot) => {
                if (querySnapshot.empty) {
                    agendamentosList.innerHTML = '<p>Nenhum agendamento encontrado.</p>';
                } else {
                    let appointmentsHTML = '';
                    querySnapshot.forEach((doc) => {
                        const appointment = doc.data();
                        appointmentsHTML += `
                            <div class="appointment-item">
                                <h3>${appointment.serviceName}</h3>
                                <p>Data: ${appointment.date}</p>
                                <p>Hora: ${appointment.time}</p>
                                <p>Local: ${appointment.location}</p>
                            </div>
                        `;
                    });
                    agendamentosList.innerHTML = appointmentsHTML;
                }
            }).catch((error) => {
                console.error("Erro ao carregar agendamentos:", error);
                agendamentosList.innerHTML = '<p>Erro ao carregar agendamentos.</p>';
            });
        }
    </script>
</body>

</html>
