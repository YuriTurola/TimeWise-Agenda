<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estabelecimento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script>
        // Initialize Firebase
     const firebaseConfig = {
      apiKey: "AIzaSyBrG14qUCGOIMucxBArrhzZ2hG2ilidwnU",
      authDomain: "time-wise-agendamentos.firebaseapp.com",
      projectId: "time-wise-agendamentos",
      storageBucket: "time-wise-agendamentos.appspot.com",
      messagingSenderId: "833338728870",
      appId: "1:833338728870:web:a80345b88915ef6a2f6f67",
      measurementId: "G-2R9ZV4P3N3"
    };
        firebase.initializeApp(firebaseConfig);
    </script>
    <style>
        /* Your custom styles here */
    </style>
</head>

<body class="bg-dark-bg text-gray-300">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4 text-center text-orange-custom">Estabelecimento</h1>
        <ul id="dataList" class="mt-8"></ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.substring(1); // Remove the '#' character
            const params = new URLSearchParams(hash);
            const cnpj = params.get('cnpj');
            
            if (cnpj) {
                document.getElementById('dataList').innerHTML = `<li>Loading data for CNPJ: ${cnpj}</li>`;
                fetchDataByCNPJ(cnpj);
            } else {
                document.getElementById('dataList').innerHTML = `<li>No CNPJ provided</li>`;
            }
        });

        function fetchDataByCNPJ(cnpj) {
            const db = firebase.firestore();

            db.collection('users')
                .where('cnpj', '==', cnpj)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        document.getElementById('dataList').innerHTML = `<li>No data found for CNPJ: ${cnpj}</li>`;
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const userId = doc.id;
                        const userInformation = doc.data();

                        db.collection('users').doc(userId).collection('services').get()
                            .then((servicesSnapshot) => {
                                if (servicesSnapshot.empty) {
                                    document.getElementById('dataList').innerHTML += `<li>No services found for CNPJ: ${cnpj}</li>`;
                                    return;
                                }

                                let userInfoHtml = `<li>User Information:</li>`;
                                userInfoHtml += `<ul>`;
                                for (const [key, value] of Object.entries(userInformation)) {
                                    userInfoHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                                }
                                userInfoHtml += `</ul>`;

                                let servicesHtml = `<li>Services:</li>`;
                                servicesHtml += `<ul>`;
                                servicesSnapshot.forEach((serviceDoc) => {
                                    const serviceData = serviceDoc.data();
                                    servicesHtml += `<li><strong>${serviceData.name}:</strong> ${serviceData.details}</li>`;
                                });
                                servicesHtml += `</ul>`;

                                document.getElementById('dataList').innerHTML = userInfoHtml + servicesHtml;
                            })
                            .catch((error) => {
                                console.error("Error fetching services:", error);
                                document.getElementById('dataList').innerHTML = `<li>Error fetching services for CNPJ: ${cnpj}</li>`;
                            });
                    });
                })
                .catch((error) => {
                    console.error("Error fetching user data:", error);
                    document.getElementById('dataList').innerHTML = `<li>Error fetching data for CNPJ: ${cnpj}</li>`;
                });
        }
    </script>
</body>

</html>
