<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppointmentPro - Agendamentos Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#000000',
                        'primary': '#b47a17',
                        'secondary': '#4A4A4A',
                        'accent': '#FFD700',
                        'text-light': '#E0E0E0',
                        'text-dark': '#0D0D0D'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg text-text-light">
    <!-- Header -->
    <nav class="bg-secondary p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-primary text-2xl font-bold flex items-center">
                <i class="fas fa-calendar-check mr-2"></i>TimeWise
            </h1>

            <div id="userProfile" class="text-text-light hidden">
                <div class="relative">
                    <button id="userDropdown" class="flex items-center space-x-2 focus:outline-none">
                        <div id="userAvatar" class="w-8 h-8 rounded-full bg-primary text-text-dark flex items-center justify-center mr-2"></div>
                        <span id="userName" class="text-text-light"></span>
                        <i class="fas fa-chevron-down text-text-light ml-2"></i>
                    </button>
                    <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-secondary rounded-md shadow-lg hidden">
                        <a href="page/appointments.html" class="block px-4 py-2 text-sm text-text-light hover:bg-primary" data-requires-auth>Meus Agendamentos</a>
                        <a href="page/profile.html" class="block px-4 py-2 text-sm text-text-light hover:bg-primary" data-requires-auth>Perfil</a>
                        <a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-text-light hover:bg-primary">Sair</a>
                    </div>
                </div>
            </div>

            <div id="authButtons" class="text-text-light hidden">
                <a href="page/login.html" class="bg-primary hover:bg-accent text-text-dark font-bold py-2 px-6 rounded-full transition duration-300 shadow-md hover:shadow-lg flex items-center justify-center">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </a>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Service provider info and schedule -->
        <div id="firebaseStatus" class="mb-4 text-center text-lg"></div>
        <div id="dataList" class="mb-8"></div>

        <!-- Button to Schedule -->
        <button id="scheduleButton" class="bg-primary hover:bg-accent text-text-dark font-bold py-2 px-4 rounded w-full">
            Quero Agendar
        </button>

        <!-- Schedule List -->
        <div id="scheduleList" class="bg-secondary p-6 rounded-lg shadow-lg">
            <!-- Weekly schedule will be appended here -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark-bg text-text-light">
        <div class="container mx-auto px-4 py-8">
            <h2 class="text-3xl font-bold mb-6 text-center text-text-light">
                <i class="fas fa-star mr-2"></i>TimeWise - O Melhor em Agendamentos Online
            </h2>
            <div class="bg-primary h-1 mb-8"></div>
        </div>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBrG14qUCGOIMucxBArrhzZ2hG2ilidwnU",
            authDomain: "time-wise-agendamentos.firebaseapp.com",
            projectId: "time-wise-agendamentos",
            storageBucket: "time-wise-agendamentos.appspot.com",
            messagingSenderId: "833338728870",
            appId: "1:833338728870:web:f4f87d0e3f9c7dc92f6f67",
            measurementId: "G-63ZD6V69EV"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        let selectedDay = '';
        let selectedTime = null;
        let selectedServiceId = '';
        let selectedCnpj = '';
        let currentStartTime = '';
        let currentEndTime = '';
        let selectedWorkerId = null;
        let isRedirecting = false;

        // Function to fetch provider data based on CNPJ
        function fetchDataByCNPJ(cnpj) {
            const statusElement = document.getElementById('firebaseStatus');
            if (!cnpj) {
                statusElement.textContent = "Por favor, insira um CNPJ.";
                statusElement.classList.add('text-red-600');
                return;
            }

            console.log("Buscando dados para o CNPJ:", cnpj);

            db.collection("users").where("cnpj", "==", cnpj).get().then((userSnapshot) => {
                if (userSnapshot.empty) {
                    statusElement.textContent = "Nenhum estabelecimento encontrado com este CNPJ.";
                    statusElement.classList.add('text-red-600');
                    return;
                }

                const userData = userSnapshot.docs[0].data();
                const userUid = userSnapshot.docs[0].id;
                const establishmentName = userData.establishmentName || 'N/A';
                const userEmail = userData.email || 'N/A';
                const userPhone = userData.phone || 'N/A';
                const logoUrl = userData.logoUrl || '';

                const dataList = document.getElementById('dataList');
                dataList.innerHTML = `
                    <div class="text-center mb-8">
                        ${logoUrl ? `<img src="${logoUrl}" alt="Logo" class="mx-auto mb-6 w-48 h-48 object-cover rounded-full border-4 shadow-lg">` : ''}
                        <h2 class="text-5xl font-extrabold text-orange-custom">${establishmentName}</h2>
                    </div>
                    <div class="bg-dark-surface p-6 rounded-lg shadow-lg mb-8">
                        <p class="mb-2"><strong class="text-orange-custom"><i class="fas fa-id-card mr-2"></i>CNPJ:</strong> ${cnpj}</p>
                        <p class="mb-2"><strong class="text-orange-custom"><i class="fas fa-envelope mr-2"></i>Email:</strong> ${userEmail}</p>
                        <p><strong class="text-orange-custom"><i class="fas fa-phone mr-2"></i>Telefone:</strong> ${userPhone}</p>
                    </div>
                    <div id="comentariosContainer" class="bg-dark-surface p-6 rounded-lg shadow-lg mb-8">
                        <h3 class="text-2xl font-bold mb-4 text-orange-custom"><i class="fas fa-comments mr-2"></i>Comentários dos Clientes</h3>
                        <div id="comentariosList" class="space-y-4"></div>
                    </div>
                `;

                // Fetch customer comments
                buscarComentarios(cnpj);

                // Fetch services from subcollection
                db.collection("users").doc(userUid).collection("services").get().then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        statusElement.textContent = "Nenhum serviço encontrado para este CNPJ.";
                        statusElement.classList.add('text-red-600');
                        return;
                    }
                    const servicesContainer = document.createElement('div');
                    servicesContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    querySnapshot.forEach((doc) => {
                        const serviceData = doc.data();
                        const serviceCard = document.createElement('div');
                        serviceCard.className = 'bg-dark-surface p-4 rounded-lg shadow-lg hover-grow fade-in';
                        serviceCard.innerHTML = `
                            <h3 class="text-xl font-bold mb-3 text-orange-custom">${serviceData.name || 'N/A'}</h3>
                            <p class="text-sm mb-3 text-gray-300">${serviceData.description || 'N/A'}</p>
                            <p class="font-bold mb-3 text-green-400">R$ ${serviceData.price || 'N/A'}</p>
                            <img src="${serviceData.imageUrl || ''}" alt="Imagem do Serviço" class="w-full h-40 object-cover rounded-lg mb-3">
                            <button onclick="agendarServico('${doc.id}', '${serviceData.name}')" class="bg-orange-custom hover:bg-orange-600 text-white font-bold py-2 px-4 rounded w-full transition duration-300 hover:shadow-lg">
                                <i class="fas fa-calendar-plus mr-2"></i>Agendar
                            </button>
                        `;
                        servicesContainer.appendChild(serviceCard);
                    });
                    dataList.appendChild(servicesContainer);
                    statusElement.textContent = "Dados carregados com sucesso!";
                    statusElement.classList.add('text-green-600');
                }).catch((error) => {
                    console.error("Erro ao buscar serviços: ", error);
                    statusElement.textContent = "Erro ao carregar dados dos serviços.";
                    statusElement.classList.add('text-red-600');
                });
            }).catch((error) => {
                console.error("Erro ao buscar estabelecimento: ", error);
                statusElement.textContent = "Erro ao carregar dados do estabelecimento.";
                statusElement.classList.add('text-red-600');
            });
        }

        function buscarComentarios(cnpj) {
            // Add logic to fetch customer comments based on the CNPJ
        }

        function agendarServico(serviceId, serviceName) {
            // Add logic to handle scheduling
        }

        // Load initial data
        fetchDataByCNPJ('51.416.544/8484-48'); // Replace with actual CNPJ
    </script>
</body>
</html>
